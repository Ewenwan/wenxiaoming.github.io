<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1447px" preserveAspectRatio="none" style="width:1254px;height:1447px;" version="1.1" viewBox="0 0 1254 1447" width="1254px" zoomAndPan="magnify"><defs><filter height="300%" id="f30jjluii2ajp" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="587.25" y="26.0439">use memory</text><rect fill="#FFFFFF" filter="url(#f30jjluii2ajp)" height="1087.2285" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="189.5034"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="67" x2="67" y1="74.2402" y2="1403.9951"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="231" x2="231" y1="74.2402" y2="1403.9951"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="448" x2="448" y1="74.2402" y2="1403.9951"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="659" x2="659" y1="74.2402" y2="1403.9951"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="858.5" x2="858.5" y1="74.2402" y2="1403.9951"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1041.5" x2="1041.5" y1="74.2402" y2="1403.9951"/><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="8" y="36.1201"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="15" y="59.1641">mali_kbase_jd.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="115" x="8" y="1402.9951"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="101" x="15" y="1426.0391">mali_kbase_jd.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="153" x="153" y="36.1201"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="139" x="160" y="59.1641">mali_kbase_softjobs.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="153" x="153" y="1402.9951"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="139" x="160" y="1426.0391">mali_kbase_softjobs.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="252" x="320" y="36.1201"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="238" x="327" y="59.1641">mamali_kbase_mmuli_kbase_replay.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="252" x="320" y="1402.9951"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="238" x="327" y="1426.0391">mamali_kbase_mmuli_kbase_replay.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="586" y="36.1201"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="593" y="59.1641">mali_kbase_replay.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="143" x="586" y="1402.9951"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="129" x="593" y="1426.0391">mali_kbase_replay.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="170" x="771.5" y="36.1201"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="156" x="778.5" y="59.1641">mali_kbase_mem_linux.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="170" x="771.5" y="1402.9951"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="156" x="778.5" y="1426.0391">mali_kbase_mem_linux.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="168" x="955.5" y="36.1201"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="962.5" y="59.1641">mali_kbase_core_linux.c</text><rect fill="#FEFECE" filter="url(#f30jjluii2ajp)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="168" x="955.5" y="1402.9951"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="962.5" y="1426.0391">mali_kbase_core_linux.c</text><rect fill="#FFFFFF" filter="url(#f30jjluii2ajp)" height="1087.2285" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="654.5" y="189.5034"/><polygon fill="#A80036" points="219.5,103.9946,229.5,107.9946,219.5,111.9946,223.5,107.9946" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="67.5" x2="225.5" y1="107.9946" y2="107.9946"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="74.5" y="103.1382">kbase_process_soft_job</text><polygon fill="#A80036" points="436,140.749,446,144.749,436,148.749,440,144.749" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="231.5" x2="442" y1="144.749" y2="144.749"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="238.5" y="139.8926">kbase_replay_process</text><path d="M453,120.9946 L453,147.9946 L593,147.9946 L593,130.9946 L583,120.9946 L453,120.9946 " fill="#ADD8E6" filter="url(#f30jjluii2ajp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M583,120.9946 L583,130.9946 L593,130.9946 L583,120.9946 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="459" y="140.8926">Process a replay job</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="659.5" x2="706.5" y1="176.5034" y2="176.5034"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="706.5" x2="706.5" y1="176.5034" y2="189.5034"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="665.5" x2="706.5" y1="189.5034" y2="189.5034"/><polygon fill="#A80036" points="675.5,185.5034,665.5,189.5034,675.5,193.5034,671.5,189.5034" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="671.5" y="171.647">kbase_replay_process_worker</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="706.5" y1="375.6702" y2="375.6702"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="706.5" x2="706.5" y1="375.6702" y2="388.6702"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="665.5" x2="706.5" y1="388.6702" y2="388.6702"/><polygon fill="#A80036" points="675.5,384.6702,665.5,388.6702,675.5,392.6702,671.5,388.6702" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="671.5" y="370.8137">kbasep_replay_parse_payload</text><path d="M235,207.5034 L235,536.5034 L645,536.5034 L645,217.5034 L635,207.5034 L235,207.5034 " fill="#ADD8E6" filter="url(#f30jjluii2ajp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M635,207.5034 L635,217.5034 L645,217.5034 L635,207.5034 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="241" y="227.4014">This will read the payload from userspace, and parse the job chains</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="241" y="245.1558">/* Process tiler job chains */</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="273" y="262.9102">if (kbasep_replay_parse_jc(kctx, jc, prev_jc,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="289" y="280.6646">payload-&gt;tiler_heap_free,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="305" y="298.4189">payload-&gt;tiler_hierarchy_mask,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="305" y="316.1733">payload-&gt;hierarchy_default_weight,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="305" y="333.9277">hw_job_id_offset, false) != 0) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="305" y="351.6821">goto out;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="273" y="369.4365">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="241" y="387.1909">/* Process fragment job chain */</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="273" y="404.9453">f_atom-&gt;jc = payload-&gt;fragment_jc;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="273" y="422.6997">if (kbasep_replay_parse_jc(kctx, payload-&gt;fragment_jc, 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="337" y="440.4541">payload-&gt;tiler_heap_free,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="337" y="458.2085">payload-&gt;fragment_hierarchy_mask,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="337" y="475.9629">payload-&gt;hierarchy_default_weight, 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="337" y="493.7173">true) != 0) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="305" y="511.4717">goto out;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="273" y="529.2261">}</text><polygon fill="#A80036" points="846.5,565.8369,856.5,569.8369,846.5,573.8369,850.5,569.8369" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="664.5" x2="852.5" y1="569.8369" y2="569.8369"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="671.5" y="564.9805">kbase_vmap</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="858.5" x2="900.5" y1="601.5913" y2="601.5913"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="900.5" x2="900.5" y1="601.5913" y2="614.5913"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="859.5" x2="900.5" y1="614.5913" y2="614.5913"/><polygon fill="#A80036" points="869.5,610.5913,859.5,614.5913,869.5,618.5913,865.5,614.5913" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="865.5" y="596.7349">kbase_vmap_prot</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="858.5" x2="900.5" y1="769.1265" y2="769.1265"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="900.5" x2="900.5" y1="769.1265" y2="782.1265"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="859.5" x2="900.5" y1="782.1265" y2="782.1265"/><polygon fill="#A80036" points="869.5,778.1265,859.5,782.1265,869.5,786.1265,865.5,782.1265" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="865.5" y="764.27">kbase_vmap_phy_pages</text><path d="M385,627.5913 L385,903.5913 L849,903.5913 L849,637.5913 L839,627.5913 L385,627.5913 " fill="#ADD8E6" filter="url(#f30jjluii2ajp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M839,627.5913 L839,637.5913 L849,637.5913 L839,627.5913 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="403" y="647.4893">// get info from the memory</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="391" y="665.2437">cpu_addr = vmap(pages, page_count, VM_MAP, prot);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="395" y="682.998"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="391" y="700.7524">map-&gt;offset_in_page = offset_in_page;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="391" y="718.5068">map-&gt;cpu_alloc = reg-&gt;cpu_alloc;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="387" x="391" y="736.2612">map-&gt;cpu_pages = &amp;kbase_get_cpu_phy_pages(reg)[page_index];</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="391" y="754.0156">map-&gt;gpu_alloc = reg-&gt;gpu_alloc;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="387" x="391" y="771.77">map-&gt;gpu_pages = &amp;kbase_get_gpu_phy_pages(reg)[page_index];</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="391" y="789.5244">map-&gt;addr = (void *)((uintptr_t)cpu_addr + offset_in_page);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="391" y="807.2788">map-&gt;size = size;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="443" x="391" y="825.0332">map-&gt;sync_needed = ((reg-&gt;flags &amp; KBASE_REG_CPU_CACHED) != 0) &amp;&amp;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="423" y="842.7876">!kbase_mem_is_imported(map-&gt;gpu_alloc-&gt;type);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="395" y="860.542"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="391" y="878.2964">if (map-&gt;sync_needed)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="423" y="896.0508">kbase_sync_mem_regions(kctx, map, KBASE_SYNC_TO_CPU);</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="858.5" x2="900.5" y1="936.6616" y2="936.6616"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="900.5" x2="900.5" y1="936.6616" y2="949.6616"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="859.5" x2="900.5" y1="949.6616" y2="949.6616"/><polygon fill="#A80036" points="869.5,945.6616,859.5,949.6616,869.5,953.6616,865.5,949.6616" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="865.5" y="931.8052">kbase_sync_mem_regions</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="858.5" x2="900.5" y1="1104.1968" y2="1104.1968"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="900.5" x2="900.5" y1="1104.1968" y2="1117.1968"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="859.5" x2="900.5" y1="1117.1968" y2="1117.1968"/><polygon fill="#A80036" points="869.5,1113.1968,859.5,1117.1968,869.5,1121.1968,865.5,1117.1968" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="865.5" y="1099.3403">kbase_sync_single</text><path d="M425,962.6616 L425,1238.6616 L849,1238.6616 L849,972.6616 L839,962.6616 L425,962.6616 " fill="#ADD8E6" filter="url(#f30jjluii2ajp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M839,962.6616 L839,972.6616 L849,972.6616 L839,962.6616 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="443" y="982.5596">// Do sync from CPU or from Device</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="431" y="1000.314">if (likely(cpu_pa == gpu_pa)) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="463" y="1018.0684">dma_addr_t dma_addr;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="435" y="1035.8228"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="463" y="1053.5771">BUG_ON(!cpu_page);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="463" y="1071.3315">BUG_ON(offset + size &gt; PAGE_SIZE);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="435" y="1089.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="463" y="1106.8403">dma_addr = kbase_dma_addr(cpu_page) + offset;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="463" y="1124.5947">if (sync_fn == KBASE_SYNC_TO_CPU)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="495" y="1142.3491">dma_sync_single_for_cpu(kctx-&gt;kbdev-&gt;dev, dma_addr,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="559" y="1160.1035">size, DMA_BIDIRECTIONAL);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="282" x="463" y="1177.8579">else if (sync_fn == KBASE_SYNC_TO_DEVICE)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="495" y="1195.6123">dma_sync_single_for_device(kctx-&gt;kbdev-&gt;dev, dma_addr,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="559" y="1213.3667">size, DMA_BIDIRECTIONAL);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="431" y="1231.1211">}</text><polygon fill="#A80036" points="78.5,1272.7319,68.5,1276.7319,78.5,1280.7319,74.5,1276.7319" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="658.5" y1="1276.7319" y2="1276.7319"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="84.5" y="1271.8755">jd_submit_atom</text><path d="M669,1252.9775 L669,1279.9775 L828,1279.9775 L828,1262.9775 L818,1252.9775 L669,1252.9775 " fill="#ADD8E6" filter="url(#f30jjluii2ajp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M818,1252.9775 L818,1262.9775 L828,1262.9775 L818,1252.9775 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="675" y="1272.8755">submit job for executing</text><polygon fill="#A80036" points="78.5,1323.3635,68.5,1327.3635,78.5,1331.3635,74.5,1327.3635" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="72.5" x2="1040.5" y1="1327.3635" y2="1327.3635"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="84.5" y="1322.5071">kbase_api_job_submit</text><path d="M1046,1294.7319 L1046,1339.7319 L1242,1339.7319 L1242,1304.7319 L1232,1294.7319 L1046,1294.7319 " fill="#ADD8E6" filter="url(#f30jjluii2ajp)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1232,1294.7319 L1232,1304.7319 L1242,1304.7319 L1232,1294.7319 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="1052" y="1314.6299">from user space through</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1052" y="1332.3843">KBASE_IOCTL_JOB_SUBMIT</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="67.5" x2="109.5" y1="1372.9951" y2="1372.9951"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="109.5" x2="109.5" y1="1372.9951" y2="1385.9951"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="68.5" x2="109.5" y1="1385.9951" y2="1385.9951"/><polygon fill="#A80036" points="78.5,1381.9951,68.5,1385.9951,78.5,1389.9951,74.5,1385.9951" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="74.5" y="1368.1387">jd_submit_atom</text><!--
@startuml
title use memory

"mali_kbase_jd.c" -> "mali_kbase_softjobs.c":kbase_process_soft_job

"mali_kbase_softjobs.c" -> "mamali_kbase_mmuli_kbase_replay.c":kbase_replay_process
note right #LightBlue:Process a replay job
"mali_kbase_replay.c" -> "mali_kbase_replay.c":kbase_replay_process_worker

activate "mali_kbase_replay.c"
"mali_kbase_replay.c" -> "mali_kbase_replay.c":kbasep_replay_parse_payload
note left #LightBlue
This will read the payload from userspace, and parse the job chains
/* Process tiler job chains */
	if (kbasep_replay_parse_jc(kctx, jc, prev_jc,
	    payload->tiler_heap_free,
		payload->tiler_hierarchy_mask,
		payload->hierarchy_default_weight,
		hw_job_id_offset, false) != 0) {
		goto out;
	}
/* Process fragment job chain */
	f_atom->jc = payload->fragment_jc;
	if (kbasep_replay_parse_jc(kctx, payload->fragment_jc, 0,
			payload->tiler_heap_free,
			payload->fragment_hierarchy_mask,
			payload->hierarchy_default_weight, 0,
			true) != 0) {
		goto out;
	}
end note
"mali_kbase_replay.c" -> "mali_kbase_mem_linux.c":kbase_vmap
"mali_kbase_mem_linux.c" -> "mali_kbase_mem_linux.c":kbase_vmap_prot
"mali_kbase_mem_linux.c" -> "mali_kbase_mem_linux.c":kbase_vmap_phy_pages
note left #LightBlue
    // get info from the memory
	cpu_addr = vmap(pages, page_count, VM_MAP, prot);

	map->offset_in_page = offset_in_page;
	map->cpu_alloc = reg->cpu_alloc;
	map->cpu_pages = &kbase_get_cpu_phy_pages(reg)[page_index];
	map->gpu_alloc = reg->gpu_alloc;
	map->gpu_pages = &kbase_get_gpu_phy_pages(reg)[page_index];
	map->addr = (void *)((uintptr_t)cpu_addr + offset_in_page);
	map->size = size;
	map->sync_needed = ((reg->flags & KBASE_REG_CPU_CACHED) != 0) &&
		!kbase_mem_is_imported(map->gpu_alloc->type);

	if (map->sync_needed)
		kbase_sync_mem_regions(kctx, map, KBASE_SYNC_TO_CPU);
end note

"mali_kbase_mem_linux.c" -> "mali_kbase_mem_linux.c":kbase_sync_mem_regions
"mali_kbase_mem_linux.c" -> "mali_kbase_mem_linux.c":kbase_sync_single
note left #LightBlue
    // Do sync from CPU or from Device
	if (likely(cpu_pa == gpu_pa)) {
		dma_addr_t dma_addr;

		BUG_ON(!cpu_page);
		BUG_ON(offset + size > PAGE_SIZE);

		dma_addr = kbase_dma_addr(cpu_page) + offset;
		if (sync_fn == KBASE_SYNC_TO_CPU)
			dma_sync_single_for_cpu(kctx->kbdev->dev, dma_addr,
					size, DMA_BIDIRECTIONAL);
		else if (sync_fn == KBASE_SYNC_TO_DEVICE)
			dma_sync_single_for_device(kctx->kbdev->dev, dma_addr,
					size, DMA_BIDIRECTIONAL);
	}
end note

"mali_kbase_replay.c" -> "mali_kbase_jd.c":jd_submit_atom
note right #LightBlue: submit job for executing
deactivate "mali_kbase_replay.c"
"mali_kbase_core_linux.c" -> "mali_kbase_jd.c":kbase_api_job_submit
note right #LightBlue
from user space through 
KBASE_IOCTL_JOB_SUBMIT
end note
"mali_kbase_jd.c" ->"mali_kbase_jd.c":jd_submit_atom

@enduml

PlantUML version 1.2019.09(Tue Aug 27 00:19:51 GMT+08:00 2019)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 13.0.2+8
Operating System: Windows 10
OS Version: 10.0
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>