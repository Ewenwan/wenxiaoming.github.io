<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="789px" preserveAspectRatio="none" style="width:905px;height:789px;" version="1.1" viewBox="0 0 905 789" width="905px" zoomAndPan="magnify"><defs><filter height="300%" id="f153h3qpk47gbb" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="86" x="410.25" y="30.6279">"app draw"</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="109" x2="109" y1="79.7031" y2="746.0542"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="239.5" x2="239.5" y1="79.7031" y2="746.0542"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="356.5" x2="356.5" y1="79.7031" y2="746.0542"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="497.5" x2="497.5" y1="79.7031" y2="746.0542"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="629.5" x2="629.5" y1="79.7031" y2="746.0542"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="742.5" x2="742.5" y1="79.7031" y2="746.0542"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="845.5" x2="845.5" y1="79.7031" y2="746.0542"/><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="38" x="88" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="24" x="95" y="64.627">app</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="38" x="88" y="745.0542"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="24" x="95" y="768.0981">app</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="190.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="197.5" y="64.627">BufferQueue</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="190.5" y="745.0542"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="81" x="197.5" y="768.0981">BufferQueue</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="299.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="306.5" y="64.627">CanvasContext</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="299.5" y="745.0542"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="306.5" y="768.0981">CanvasContext</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="145" x="423.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="131" x="430.5" y="64.627">SkiaOpenGLPipeline</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="145" x="423.5" y="745.0542"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="131" x="430.5" y="768.0981">SkiaOpenGLPipeline</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="90" x="582.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="589.5" y="64.627">EglManager</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="90" x="582.5" y="745.0542"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="76" x="589.5" y="768.0981">EglManager</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="701.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="708.5" y="64.627">gpu driver</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="701.5" y="745.0542"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="708.5" y="768.0981">gpu driver</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="793.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="800.5" y="64.627">gpu hardware</text><rect fill="#FEFECE" filter="url(#f153h3qpk47gbb)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="793.5" y="745.0542"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="800.5" y="768.0981">gpu hardware</text><polygon fill="#A80036" points="228,176.5979,238,180.5979,228,184.5979,232,180.5979" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="109" x2="234" y1="180.5979" y2="180.5979"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="107" x="116" y="175.7415">createBufferQueue</text><path d="M245,94.7031 L245,246.7031 L814,246.7031 L814,104.7031 L804,94.7031 L245,94.7031 " fill="#ADD8E6" filter="url(#f153h3qpk47gbb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M804,94.7031 L804,104.7031 L814,104.7031 L804,94.7031 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="251" y="114.6011">sp&lt;IGraphicBufferProducer&gt; producer;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="251" y="132.3555">sp&lt;IGraphicBufferConsumer&gt; consumer;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="251" y="150.1099">BufferQueue::createBufferQueue(&amp;producer, &amp;consumer);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="251" y="167.8643">producer-&gt;setMaxDequeuedBufferCount(3);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="251" y="185.6187">producer-&gt;setAsyncMode(true);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="548" x="251" y="203.373">mConsumer = new BufferItemConsumer(consumer, GRALLOC_USAGE_HW_COMPOSER, 4);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="251" y="221.1274">mConsumer-&gt;setDefaultBufferSize(gDisplay.w, gDisplay.h);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="251" y="238.8818">mSurface = new Surface(producer);</text><polygon fill="#A80036" points="344.5,280.4927,354.5,284.4927,344.5,288.4927,348.5,284.4927" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="109" x2="350.5" y1="284.4927" y2="284.4927"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="116" y="279.6362">setSurface</text><path d="M361,260.7383 L361,287.7383 L565,287.7383 L565,270.7383 L555,260.7383 L361,260.7383 " fill="#ADD8E6" filter="url(#f153h3qpk47gbb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M555,260.7383 L555,270.7383 L565,270.7383 L555,260.7383 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="367" y="280.6362">set mSurface to CanvasContext</text><polygon fill="#A80036" points="486,317.2471,496,321.2471,486,325.2471,490,321.2471" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="356.5" x2="492" y1="321.2471" y2="321.2471"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="363.5" y="316.3906">setSurface</text><polygon fill="#A80036" points="617.5,362.8787,627.5,366.8787,617.5,370.8787,621.5,366.8787" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="498" x2="623.5" y1="366.8787" y2="366.8787"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="505" y="362.0222">createSurface</text><path d="M43,334.2471 L43,379.2471 L489,379.2471 L489,344.2471 L479,334.2471 L43,334.2471 " fill="#ADD8E6" filter="url(#f153h3qpk47gbb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M479,334.2471 L479,344.2471 L489,344.2471 L479,334.2471 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="49" y="354.145">EGLSurface surface = eglCreateWindowSurface(mEglDisplay,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="425" x="49" y="371.8994">wideColorGamut ? mEglConfigWideGamut : mEglConfig, window, attribs);</text><polygon fill="#A80036" points="344.5,408.5103,354.5,412.5103,344.5,416.5103,348.5,412.5103" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="109" x2="350.5" y1="412.5103" y2="412.5103"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="116" y="407.6538">draw</text><polygon fill="#A80036" points="486,440.2646,496,444.2646,486,448.2646,490,444.2646" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="356.5" x2="492" y1="444.2646" y2="444.2646"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="363.5" y="439.4082">draw</text><polygon fill="#A80036" points="486,472.019,496,476.019,486,480.019,490,476.019" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="356.5" x2="492" y1="476.019" y2="476.019"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="363.5" y="471.1626">swapBuffers</text><polygon fill="#A80036" points="617.5,503.7734,627.5,507.7734,617.5,511.7734,621.5,507.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="498" x2="623.5" y1="507.7734" y2="507.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="505" y="502.917">swapBuffers</text><polygon fill="#A80036" points="730.5,540.5278,740.5,544.5278,730.5,548.5278,734.5,544.5278" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="629.5" x2="736.5" y1="544.5278" y2="544.5278"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="636.5" y="539.6714">eglSwapBuffers</text><path d="M238,520.7734 L238,547.7734 L620,547.7734 L620,530.7734 L610,520.7734 L238,520.7734 " fill="#ADD8E6" filter="url(#f153h3qpk47gbb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M610,520.7734 L610,530.7734 L620,530.7734 L610,520.7734 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="244" y="540.6714">use eglSwapBuffersWithDamageKHR to update specific region</text><polygon fill="#A80036" points="251,582.2822,241,586.2822,251,590.2822,247,586.2822" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="245" x2="741.5" y1="586.2822" y2="586.2822"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="257" y="581.4258">dequeueBuffer</text><path d="M41,562.5278 L41,589.5278 L231,589.5278 L231,572.5278 L221,562.5278 L41,562.5278 " fill="#ADD8E6" filter="url(#f153h3qpk47gbb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M221,562.5278 L221,572.5278 L231,572.5278 L221,562.5278 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="47" y="582.4258">find one free buffer for using it</text><polygon fill="#A80036" points="834,624.0366,844,628.0366,834,632.0366,838,628.0366" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="742.5" x2="840" y1="628.0366" y2="628.0366"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="749.5" y="623.1802">draw</text><path d="M519,604.2822 L519,631.2822 L733,631.2822 L733,614.2822 L723,604.2822 L519,604.2822 " fill="#ADD8E6" filter="url(#f153h3qpk47gbb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M723,604.2822 L723,614.2822 L733,614.2822 L723,604.2822 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="525" y="624.1802">execute hardware drawing on gpu</text><polygon fill="#A80036" points="251,692.4226,241,696.4226,251,700.4226,247,696.4226" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="245" x2="741.5" y1="696.4226" y2="696.4226"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="257" y="691.5662">queueBuffer</text><path d="M8,646.0366 L8,727.0366 L231,727.0366 L231,656.0366 L221,646.0366 L8,646.0366 " fill="#ADD8E6" filter="url(#f153h3qpk47gbb)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M221,646.0366 L221,656.0366 L231,656.0366 L221,646.0366 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="186" x="14" y="665.9346">the buffer will not be available for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="14" y="683.689">using until the fence is triggered by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="14" y="701.4434">gpu driver once the drawing on the</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="14" y="719.1978">buffer is done</text><!--MD5=[5d70512ed9176344c882ca530dd307e5]
@startuml
title "app draw"

app -> BufferQueue:createBufferQueue
note right #LightBlue
    sp<IGraphicBufferProducer> producer;
    sp<IGraphicBufferConsumer> consumer;
    BufferQueue::createBufferQueue(&producer, &consumer);
    producer->setMaxDequeuedBufferCount(3);
    producer->setAsyncMode(true);
    mConsumer = new BufferItemConsumer(consumer, GRALLOC_USAGE_HW_COMPOSER, 4);
    mConsumer->setDefaultBufferSize(gDisplay.w, gDisplay.h);
    mSurface = new Surface(producer);
end note
app -> CanvasContext:setSurface
note right #LightBlue
set mSurface to CanvasContext
end note
CanvasContext->SkiaOpenGLPipeline:setSurface
SkiaOpenGLPipeline -> EglManager:createSurface
note left #LightBlue
    EGLSurface surface = eglCreateWindowSurface(mEglDisplay,
    wideColorGamut ? mEglConfigWideGamut : mEglConfig, window, attribs);
end note

app -> CanvasContext:draw
CanvasContext -> SkiaOpenGLPipeline: draw
CanvasContext -> SkiaOpenGLPipeline: swapBuffers
SkiaOpenGLPipeline -> EglManager:swapBuffers
EglManager -> "gpu driver":eglSwapBuffers
note left #LightBlue: use eglSwapBuffersWithDamageKHR to update specific region
"gpu driver" -> BufferQueue: dequeueBuffer
note left #LightBlue: find one free buffer for using it
"gpu driver" -> "gpu hardware": draw
note left #LightBlue: execute hardware drawing on gpu
"gpu driver" -> BufferQueue: queueBuffer
note left #LightBlue
the buffer will not be available for 
using until the fence is triggered by
gpu driver once the drawing on the 
buffer is done
end note
@enduml

PlantUML version 1.2020.10(Sun May 17 17:35:57 GMT+08:00 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 13.0.2+8
Operating System: Windows 10
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>