<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1099px" preserveAspectRatio="none" style="width:1630px;height:1099px;" version="1.1" viewBox="0 0 1630 1099" width="1630px" zoomAndPan="magnify"><defs><filter height="300%" id="fazhay9ru4he4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="143" x="744.25" y="30.6279">"compositor draw"</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="33" x2="33" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="124" x2="124" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="216" x2="216" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="387" x2="387" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="500.5" x2="500.5" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="623.5" x2="623.5" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="794.5" x2="794.5" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="943.5" x2="943.5" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1029.5" x2="1029.5" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1136.5" x2="1136.5" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1281.5" x2="1281.5" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1405.5" x2="1405.5" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1503.5" x2="1503.5" y1="79.7031" y2="1056.1069"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1585.5" x2="1585.5" y1="79.7031" y2="1056.1069"/><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="8" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="15" y="64.627">app1</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="8" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="15" y="1078.1509">app1</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="50" x="97" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="36" x="104" y="64.627">Layer</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="50" x="97" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="36" x="104" y="1078.1509">Layer</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="107" x="161" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="168" y="64.627">SurfaceFlinger</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="107" x="161" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="168" y="1078.1509">SurfaceFlinger</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="103" x="334" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="341" y="64.627">DisplayDevice</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="103" x="334" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="89" x="341" y="1078.1509">DisplayDevice</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="459.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="466.5" y="64.627">gpu driver</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="78" x="459.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="64" x="466.5" y="1078.1509">gpu driver</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="551.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="558.5" y="64.627">app1's BufferQueue</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="551.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="558.5" y="1078.1509">app1's BufferQueue</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="706.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="713.5" y="64.627">SurfaceFlingerConsumer</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="172" x="706.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="158" x="713.5" y="1078.1509">SurfaceFlingerConsumer</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="98" x="892.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="84" x="899.5" y="64.627">GLConsumer</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="98" x="892.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="84" x="899.5" y="1078.1509">GLConsumer</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="1004.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="1011.5" y="64.627">app2</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="46" x="1004.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="1011.5" y="1078.1509">app2</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="1064.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="1071.5" y="64.627">app2's BufferQueue</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="1064.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="1071.5" y="1078.1509">app2's BufferQueue</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="1219.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="1226.5" y="64.627">sf's BufferQueue</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="1219.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="1226.5" y="1078.1509">sf's BufferQueue</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="1353.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="1360.5" y="64.627">gpu hardware</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="1353.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="1360.5" y="1078.1509">gpu hardware</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="1468.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="1475.5" y="64.627">fb driver</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="66" x="1468.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="52" x="1475.5" y="1078.1509">fb driver</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1548.5" y="41.583"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1555.5" y="64.627">lcd panel</text><rect fill="#FEFECE" filter="url(#fazhay9ru4he4)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="71" x="1548.5" y="1055.1069"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="57" x="1555.5" y="1078.1509">lcd panel</text><polygon fill="#A80036" points="112,194.3523,122,198.3523,112,202.3523,116,198.3523" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="33" x2="118" y1="198.3523" y2="198.3523"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="67" x="40" y="193.4958">onFirstRef()</text><path d="M129,94.7031 L129,281.7031 L682,281.7031 L682,104.7031 L672,94.7031 L129,94.7031 " fill="#ADD8E6" filter="url(#fazhay9ru4he4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M672,94.7031 L672,104.7031 L682,104.7031 L672,94.7031 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="135" y="114.6011">// Creates a custom BufferQueue for app to push buffer to it.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="135" y="132.3555">// SurfaceFlinger can get buffer from it for composition.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="135" y="150.1099">sp&lt;IGraphicBufferProducer&gt; producer;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="135" y="167.8643">sp&lt;IGraphicBufferConsumer&gt; consumer;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="135" y="185.6187">BufferQueue::createBufferQueue(&amp;producer, &amp;consumer, true);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="135" y="203.373">mProducer = new MonitoredProducer(producer, mFlinger, this);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="532" x="135" y="221.1274">mSurfaceFlingerConsumer = new SurfaceFlingerConsumer(consumer, mTextureName, this);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="135" y="238.8818">mSurfaceFlingerConsumer-&gt;setConsumerUsageBits(getEffectiveUsage(0));</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="365" x="135" y="256.6362">mSurfaceFlingerConsumer-&gt;setContentsChangedListener(this);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="135" y="274.3906">mSurfaceFlingerConsumer-&gt;setName(mName);</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="216.5" x2="258.5" y1="340.1331" y2="340.1331"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="258.5" x2="258.5" y1="340.1331" y2="353.1331"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="217.5" x2="258.5" y1="353.1331" y2="353.1331"/><polygon fill="#A80036" points="227.5,349.1331,217.5,353.1331,227.5,357.1331,223.5,353.1331" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="223.5" y="335.2766">createDefaultDisplayDevice</text><path d="M392,296.2471 L392,377.2471 L882,377.2471 L882,306.2471 L872,296.2471 L392,296.2471 " fill="#ADD8E6" filter="url(#fazhay9ru4he4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M872,296.2471 L872,306.2471 L882,306.2471 L872,296.2471 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="398" y="316.145">sp&lt;IGraphicBufferProducer&gt; producer;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="398" y="333.8994">sp&lt;IGraphicBufferConsumer&gt; consumer;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="398" y="351.6538">BufferQueue::createBufferQueue(&amp;producer, &amp;consumer);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="469" x="398" y="369.4082">sp&lt;FramebufferSurface&gt; fbs = new FramebufferSurface(*mHwc, type, consumer);</text><polygon fill="#A80036" points="375.5,455.405,385.5,459.405,375.5,463.405,379.5,459.405" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="216.5" x2="381.5" y1="459.405" y2="459.405"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="223.5" y="454.5486">new</text><path d="M392,391.2646 L392,507.2646 L820,507.2646 L820,401.2646 L810,391.2646 L392,391.2646 " fill="#ADD8E6" filter="url(#fazhay9ru4he4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M810,391.2646 L810,401.2646 L820,401.2646 L810,391.2646 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="398" y="411.1626">Surface* surface;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="398" y="428.917">mNativeWindow = surface = new Surface(producer, false);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="398" y="446.6714">ANativeWindow* const window = mNativeWindow.get();</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="398" y="464.4258">EGLSurface eglSurface;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="398" y="482.1802">EGLDisplay display = eglGetDisplay(EGL_DEFAULT_DISPLAY);</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="398" y="499.9346">eglSurface = eglCreateWindowSurface(display, config, window, NULL);</text><polygon fill="#A80036" points="488.5,536.5454,498.5,540.5454,488.5,544.5454,492.5,540.5454" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="33" x2="494.5" y1="540.5454" y2="540.5454"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="40" y="535.689">eglSwapBuffers</text><polygon fill="#A80036" points="612,568.2998,622,572.2998,612,576.2998,616,572.2998" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="33" x2="618" y1="572.2998" y2="572.2998"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="40" y="567.4434">queueBuffer</text><polygon fill="#A80036" points="782.5,600.0542,792.5,604.0542,782.5,608.0542,786.5,604.0542" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="624" x2="788.5" y1="604.0542" y2="604.0542"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="631" y="599.1978">updateTexImage</text><polygon fill="#A80036" points="931.5,631.8086,941.5,635.8086,931.5,639.8086,935.5,635.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="794.5" x2="937.5" y1="635.8086" y2="635.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="801.5" y="630.9521">eglCreateImageKHR</text><polygon fill="#A80036" points="1125,663.563,1135,667.563,1125,671.563,1129,667.563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1029.5" x2="1131" y1="667.563" y2="667.563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1036.5" y="662.7065">queueBuffer</text><polygon fill="#A80036" points="612,700.3174,622,704.3174,612,708.3174,616,704.3174" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="216.5" x2="618" y1="704.3174" y2="704.3174"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="223.5" y="699.4609">wait</text><path d="M629,680.563 L629,707.563 L873,707.563 L873,690.563 L863,680.563 L629,680.563 " fill="#ADD8E6" filter="url(#fazhay9ru4he4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M863,680.563 L863,690.563 L873,690.563 L863,680.563 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="635" y="700.4609">wait for the complete of app1's drawing</text><polygon fill="#A80036" points="1125,742.0718,1135,746.0718,1125,750.0718,1129,746.0718" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="216.5" x2="1131" y1="746.0718" y2="746.0718"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="223.5" y="741.2153">wait</text><path d="M1142,722.3174 L1142,749.3174 L1386,749.3174 L1386,732.3174 L1376,722.3174 L1142,722.3174 " fill="#ADD8E6" filter="url(#fazhay9ru4he4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1376,722.3174 L1376,732.3174 L1386,732.3174 L1376,722.3174 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="1148" y="742.2153">wait for the complete of app2's drawing</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="216.5" x2="258.5" y1="782.8262" y2="782.8262"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="258.5" x2="258.5" y1="782.8262" y2="795.8262"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="217.5" x2="258.5" y1="795.8262" y2="795.8262"/><polygon fill="#A80036" points="227.5,791.8262,217.5,795.8262,227.5,799.8262,223.5,795.8262" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="223.5" y="777.9697">doDisplayComposition</text><polygon fill="#A80036" points="375.5,823.5806,385.5,827.5806,375.5,831.5806,379.5,827.5806" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="216.5" x2="381.5" y1="827.5806" y2="827.5806"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="223.5" y="822.7241">swapBuffers</text><polygon fill="#A80036" points="488.5,855.335,498.5,859.335,488.5,863.335,492.5,859.335" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="387.5" x2="494.5" y1="859.335" y2="859.335"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="394.5" y="854.4785">eglSwapBuffers</text><polygon fill="#A80036" points="1269.5,892.0894,1279.5,896.0894,1269.5,900.0894,1273.5,896.0894" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="500.5" x2="1275.5" y1="896.0894" y2="896.0894"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="82" x="507.5" y="891.2329">dequeueBuffer</text><path d="M301,872.335 L301,899.335 L491,899.335 L491,882.335 L481,872.335 L301,872.335 " fill="#ADD8E6" filter="url(#fazhay9ru4he4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M481,872.335 L481,882.335 L491,882.335 L481,872.335 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="307" y="892.2329">find one free buffer for using it</text><polygon fill="#A80036" points="1394,933.8438,1404,937.8438,1394,941.8438,1398,937.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="500.5" x2="1400" y1="937.8438" y2="937.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="507.5" y="932.9873">draw</text><path d="M277,914.0894 L277,941.0894 L491,941.0894 L491,924.0894 L481,914.0894 L277,914.0894 " fill="#ADD8E6" filter="url(#fazhay9ru4he4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M481,914.0894 L481,924.0894 L491,924.0894 L481,914.0894 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="283" y="933.9873">execute hardware drawing on gpu</text><polygon fill="#A80036" points="1269.5,970.5981,1279.5,974.5981,1269.5,978.5981,1273.5,974.5981" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="500.5" x2="1275.5" y1="974.5981" y2="974.5981"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="507.5" y="969.7417">queueBuffer</text><polygon fill="#A80036" points="1491.5,1002.3525,1501.5,1006.3525,1491.5,1010.3525,1495.5,1006.3525" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1281.5" x2="1497.5" y1="1006.3525" y2="1006.3525"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="25" x="1288.5" y="1001.4961">post</text><polygon fill="#A80036" points="1574,1034.1069,1584,1038.1069,1574,1042.1069,1578,1038.1069" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1503.5" x2="1580" y1="1038.1069" y2="1038.1069"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1510.5" y="1033.2505">draw</text><!--MD5=[0de87744c3de281de733919f971f5912]
@startuml
title "compositor draw"

app1 ->Layer:onFirstRef()
note right #LightBlue
    // Creates a custom BufferQueue for app to push buffer to it.
    // SurfaceFlinger can get buffer from it for composition.
    sp<IGraphicBufferProducer> producer;
    sp<IGraphicBufferConsumer> consumer;
    BufferQueue::createBufferQueue(&producer, &consumer, true);
    mProducer = new MonitoredProducer(producer, mFlinger, this);
    mSurfaceFlingerConsumer = new SurfaceFlingerConsumer(consumer, mTextureName, this);
    mSurfaceFlingerConsumer->setConsumerUsageBits(getEffectiveUsage(0));
    mSurfaceFlingerConsumer->setContentsChangedListener(this);
    mSurfaceFlingerConsumer->setName(mName);
end note

SurfaceFlinger -> SurfaceFlinger:createDefaultDisplayDevice
note right #LightBlue
    sp<IGraphicBufferProducer> producer;
    sp<IGraphicBufferConsumer> consumer;
    BufferQueue::createBufferQueue(&producer, &consumer);
    sp<FramebufferSurface> fbs = new FramebufferSurface(*mHwc, type, consumer);
end note

SurfaceFlinger -> DisplayDevice:new
note right #LightBlue
    Surface* surface;
    mNativeWindow = surface = new Surface(producer, false);
    ANativeWindow* const window = mNativeWindow.get();
    EGLSurface eglSurface;
    EGLDisplay display = eglGetDisplay(EGL_DEFAULT_DISPLAY);
    eglSurface = eglCreateWindowSurface(display, config, window, NULL);
end note


app1 -> "gpu driver":eglSwapBuffers
app1 -> "app1's BufferQueue":queueBuffer
"app1's BufferQueue" -> SurfaceFlingerConsumer:updateTexImage
SurfaceFlingerConsumer -> GLConsumer: eglCreateImageKHR
app2 -> "app2's BufferQueue":queueBuffer

SurfaceFlinger -> "app1's BufferQueue":wait
note right #LightBlue: wait for the complete of app1's drawing
SurfaceFlinger -> "app2's BufferQueue":wait
note right #LightBlue: wait for the complete of app2's drawing

SurfaceFlinger -> SurfaceFlinger:doDisplayComposition
SurfaceFlinger -> DisplayDevice: swapBuffers
DisplayDevice -> "gpu driver":eglSwapBuffers
"gpu driver" -> "sf's BufferQueue": dequeueBuffer
note left #LightBlue: find one free buffer for using it
"gpu driver" -> "gpu hardware": draw
note left #LightBlue: execute hardware drawing on gpu
"gpu driver" -> "sf's BufferQueue": queueBuffer
"sf's BufferQueue" -> "fb driver": post
"fb driver" -> "lcd panel":draw
@enduml

PlantUML version 1.2020.10(Sun May 17 17:35:57 GMT+08:00 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 13.0.2+8
Operating System: Windows 10
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>